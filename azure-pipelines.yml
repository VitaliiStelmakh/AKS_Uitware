trigger:
  branches:
    include:
    - main  # Adjust branch name as necessary
  paths:
    include:
    - ./charts/bestrong-api  # Adjust path as necessary

pool:
  vmImage: 'ubuntu-latest'

variables:
  acrName: 'HelmContainer'  # Add your Azure Container Registry name
  servicePrincipalId: 3ed5bd2c-7b57-4b13-8303-bd6d683a8589
  servicePrincipalKey: pq78Q~f4vgS06w_Sq7dOst0cn2uEoHuHryh93biN
  tenantId: 7631cd62-5187-4e15-8b8e-ef653e366e7a

steps:
- task: HelmInstaller@0
  inputs:
    helmVersion: '3.14.4'
    installKubectl: true

- script: |
    echo "Logging into Azure..."
    az login --service-principal -u $(servicePrincipalId) -p $(servicePrincipalKey) --tenant $(tenantId)
    az acr login --name $(acrName)
  displayName: 'Azure Login'

- script: |
    echo "Packaging Helm charts..."
    cd ./charts/bestrong-api # Navigate to the Helm chart directory
    pwd
    helm package . --version $(Build.BuildId) --destination .  # Package the chart with an auto-generated version
    ls
  displayName: 'Package Helm Chart'

- script: |
    echo "Pushing Helm chart to Azure Container Registry as OCI artifact..."
    cd ./charts/bestrong-api
    pwd
    ls
    helm push bestrong-api-$(Build.BuildId).tgz oci://$(acrName).azurecr.io/mychart
  displayName: 'Push Helm Chart as OCI Artifact'

- script: |
    echo "Cleaning up..."
    helm registry logout oci://$(acrName).azurecr.io
  displayName: 'Logout from ACR'
